<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' file: data:;" />
    <title>タスク編集（新） - NyanTaskNotes</title>
    <style>
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #ddd; }
      main { height: calc(100vh - 52px); overflow: auto; padding: 16px; display: flex; justify-content: center; }
      #left { width: 100%; max-width: 640px; }
      .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
      label { width: 120px; color: #333; }
      input[type=text], input[type=date], input[type=time], input[type=number], select, textarea { flex: 1; padding: 6px 8px; }
      textarea { min-height: 80px; }
      .actions { display: flex; gap: 8px; }
      h3 { margin-top: 20px; }
      .list { display:flex; flex-direction:column; gap:6px; }
      .occ { display:flex; gap:8px; align-items:center; border-bottom:1px solid #f3f3f3; padding:6px 0; }
      .meta { color:#666; font-size:12px; }
      .tag-controls { flex:1; display:flex; flex-direction:column; gap:8px; }
      .tag-chips { display:flex; flex-wrap:wrap; gap:8px; }
      .tag-chip { border:1px solid #ddd; border-radius:12px; padding:4px 10px; font-size:12px; cursor:pointer; user-select:none; background:#f8f8f8; color:#333; transition:background 0.2s ease, border-color 0.2s ease, color 0.2s ease; }
      .tag-chip.on { background:#eef6ff; border-color:#99c5ff; color:#0b61d8; }
      .tag-empty { color:#777; font-size:12px; }
      .tag-ops { display:flex; gap:6px; }
      .tag-ops input { flex:1; padding:6px 8px; }
      .tag-ops button { padding:6px 12px; }
      .file-controls { flex:1; display:flex; flex-direction:column; gap:8px; }
      .file-list { display:flex; flex-direction:column; gap:6px; }
      .file-item { display:flex; gap:8px; align-items:center; padding:6px 8px; border:1px solid #eee; border-radius:6px; background:#fafafa; }
      .file-item.missing { border-color:#f5b5b5; background:#fff5f5; }
      .file-item-info { flex:1; min-width:0; display:flex; flex-direction:column; gap:2px; }
      .file-item-name { font-size:14px; font-weight:500; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .file-item-path { font-size:11px; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .file-item-hash { font-size:11px; color:#888; }
      .file-actions { display:flex; gap:6px; }
      .file-actions button { padding:4px 8px; font-size:12px; }
      .file-button-row { display:flex; gap:6px; }
      .file-button-row button { padding:6px 12px; }
      .file-notice { font-size:12px; color:#777; }
      .file-notice.warning { color:#c00; }
      .file-empty { font-size:12px; color:#777; }
    </style>
  </head>
  <body>
    <header>
      <div>タスク編集（新）</div>
      <div class="actions">
        <button id="saveBtn">保存</button>
        <button id="duplicateBtn">この設定で新規作成</button>
        <button id="deleteBtn">削除</button>
      </div>
    </header>
    <main>
      <section id="left">
        <form id="taskForm" onsubmit="return false;">
          <input type="hidden" id="taskId" />
          <div class="row"><label for="title">タイトル</label><input id="title" type="text" required /></div>
          <div class="row"><label for="description">説明</label><textarea id="description"></textarea></div>
          <div class="row tag-row"><label for="tags">タグ</label>
            <div class="tag-controls">
              <div id="tagChips" class="tag-chips"></div>
              <div class="tag-ops">
                <input id="tagAddInput" type="text" placeholder="タグ名を入力" />
                <button id="tagAddBtn" type="button">追加</button>
              </div>
              <input id="tags" type="hidden" />
            </div>
          </div>
          <div class="row file-row"><label>関連ファイル</label>
            <div class="file-controls">
              <div id="fileDbNotice" class="file-notice" style="display:none;"></div>
              <div id="fileList" class="file-list"></div>
              <div class="file-button-row">
                <button id="fileAddBtn" type="button">ファイルを追加</button>
              </div>
            </div>
          </div>
          <div class="row"><label for="requireCompleteComment">完了時コメント</label><label style="flex:1;"><input id="requireCompleteComment" type="checkbox" /> 完了時にコメント入力を促す</label></div>
          <div class="row"><label for="dueAt">期日（単発）</label><input id="dueAt" type="date" /></div>
          <h3>繰り返し</h3>
          <div class="row"><label for="isRecurring">繰り返し</label>
            <select id="isRecurring">
              <option value="once">１回のみ</option>
              <option value="manualNext">完了後に次の期日を指定</option>
              <option value="daily">毎日</option>
              <option value="everyNScheduled">指定日数ごと（前回発生した日付から）</option>
              <option value="everyNCompleted">指定日数ごと（前回完了した日付から）</option>
              <option value="weekly">毎週（曜日）</option>
              <option value="monthly">毎月（日付）</option>
              <option value="monthlyNth">第n週m曜日</option>
              <option value="yearly">毎年（月日）</option>
            </select>
          </div>
          <div class="row"><label for="startDate">開始日</label><input id="startDate" type="date" /></div>
          <div class="row"><label for="startTime">開始時刻</label><input id="startTime" type="time" /></div>
          <div class="row" id="rowInterval"><label for="intervalDays">間隔（日）</label><input id="intervalDays" type="number" min="1" max="365" placeholder="例: 2" /></div>
          <div class="row" id="rowHorizon"><label for="dailyHorizonDays">生成日数（日次・発生基準）</label><input id="dailyHorizonDays" type="number" min="1" max="365" placeholder="例: 14" /></div>
          <div class="row" id="rowMonthlyDay"><label for="monthlyDay">毎月の日</label><input id="monthlyDay" type="number" min="1" max="31" placeholder="1..31" /></div>
          <div class="row" id="rowMonthlyNth"><label for="monthlyNth">第n週</label>
            <select id="monthlyNth">
              <option value="1">第1</option>
              <option value="2">第2</option>
              <option value="3">第3</option>
              <option value="4">第4</option>
              <option value="5">第5</option>
              <option value="-1">最終</option>
            </select>
            <select id="monthlyNthDow" style="flex:1;">
              <option value="0">日曜日</option>
              <option value="1">月曜日</option>
              <option value="2">火曜日</option>
              <option value="3">水曜日</option>
              <option value="4">木曜日</option>
              <option value="5">金曜日</option>
              <option value="6">土曜日</option>
            </select>
          </div>
          <div class="row" id="rowWeekly"><label>曜日</label>
            <div id="weeklyDows" style="display:flex; gap:8px; flex-wrap: wrap;">
              <label><input type="checkbox" value="0"> 日</label>
              <label><input type="checkbox" value="1"> 月</label>
              <label><input type="checkbox" value="2"> 火</label>
              <label><input type="checkbox" value="3"> 水</label>
              <label><input type="checkbox" value="4"> 木</label>
              <label><input type="checkbox" value="5"> 金</label>
              <label><input type="checkbox" value="6"> 土</label>
            </div>
          </div>
          <div class="row" id="rowYearlyMonth"><label for="yearlyMonth">毎年の月</label>
            <select id="yearlyMonth">
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
          </div>
          <div class="row" id="rowYearlyDay"><label for="yearlyDay">毎年の日</label><input id="yearlyDay" type="number" min="1" max="31" placeholder="1..31" /></div>
          <div class="row"><label for="recurrenceCount">繰り返し回数</label><input id="recurrenceCount" type="number" min="0" placeholder="0=無限, 1.." /></div>
        </form>
        <div id="logs" style="margin-top:16px; display:none;">
          <h3>最近のログ</h3>
          <div id="logsList" class="list"></div>
        </div>
      </section>
    </main>
    <script type="module" src="js/taskEditor2.js"></script>
  </body>
  </html>
